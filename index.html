<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StarShopList</title>

<style>
  :root {
    --primary: #007bff;
    --success: #28a745;
    --warning: #ff9800;
    --danger: #f44336;
    --light-bg: #d5f8d4;
    --dark-text: #333;
    --light-text: #fff;
    --border-radius: 8px;
    --transition: all 0.3s ease;
  }

  * {
    box-sizing: border-box;
  }

  body { 
    font-family: Arial, sans-serif; 
    background: var(--light-bg); 
    margin: 0; 
    padding: 10px;
    color: var(--dark-text);
  }

  .header {
    text-align: center; 
    background: var(--primary); 
    color: var(--light-text);
    padding: 12px; 
    font-size: 22px; 
    font-weight: bold;
    border-bottom-left-radius: 10px; 
    border-bottom-right-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: var(--transition);
  }

  .input-section { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    margin-top: 20px;
  }

  .item-box {
    width: 85%; 
    padding: 14px; 
    border-radius: var(--border-radius); 
    border: 1px solid #aaa;
    font-size: 17px; 
    margin-bottom: 10px;
    transition: var(--transition);
  }

  .item-box:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }

  .round-box {
    width: 40%; 
    padding: 10px; 
    text-align: center;
    border-radius: 15px; 
    border: 1px solid #aaa; 
    font-size: 16px;
    transition: var(--transition);
  }

  .round-box:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }

  .add-btn {
    width: 60px; 
    height: 60px; 
    border-radius: 50%; 
    font-size: 22px;
    background: var(--primary); 
    color: var(--light-text); 
    border: none; 
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .add-btn:hover {
    background: #0056b3;
    transform: scale(1.05);
  }

  table { 
    width: 100%; 
    border-collapse: collapse; 
    background: white; 
    margin-top: 10px; 
    font-size: 16px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  th, td { 
    border: 1px solid #ddd; 
    padding: 8px; 
    text-align: center; 
    transition: var(--transition);
  }

  th { 
    background: #333; 
    color: var(--light-text); 
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  tr:hover {
    background-color: #f1f1f1;
  }

  .btn-row { 
    text-align: center; 
    margin-top: 20px; 
  }

  .btn-row button { 
    padding: 10px 15px; 
    border: none; 
    border-radius: var(--border-radius); 
    margin: 5px; 
    color: var(--light-text); 
    font-weight: bold;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .btn-row button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .export { background: var(--success); }
  .export:hover { background: #218838; }

  .share { background: var(--warning); }
  .share:hover { background: #e68900; }

  .clear { background: var(--danger); }
  .clear:hover { background: #d32f2f; }

  .delete-btn {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    transition: var(--transition);
  }

  .delete-btn:hover {
    background: #d32f2f;
    transform: scale(1.05);
  }

  .empty-state {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
  }

  .fade-in {
    animation: fadeIn 0.5s;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .pulse {
    animation: pulse 0.5s;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    .input-section > div {
      flex-direction: column;
      width: 85%;
    }
    
    .round-box {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .add-btn {
      align-self: center;
    }
    
    table {
      font-size: 14px;
    }
    
    th, td {
      padding: 6px 4px;
    }
  }
</style>
</head>
<body>

<div class="header">StarShopList – <span id="todayDate"></span></div>

<!-- INPUT -->
<div class="input-section">
  <input type="text" id="item" class="item-box" placeholder="Enter Item Name">

  <div style="display:flex; gap:10px; width: 85%;">
    <input type="text" id="qty" class="round-box" placeholder="Qty (Optional)">
    <input type="text" id="rate" class="round-box" placeholder="Rate (Optional)">
    <button class="add-btn" onclick="addItem()" aria-label="Add Item">+</button>
  </div>
</div>

<!-- TABLE -->
<table id="listTable">
  <thead>
    <tr>
      <th>✔</th>
      <th>Item</th>
      <th>Qty</th>
      <th>Rate</th>
      <th>Amount</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3 style="text-align:center;">Total: ₹<span id="totalAmount">0</span></h3>

<!-- FOOTER BUTTONS -->
<div class="btn-row">
  <button class="export" onclick="exportCSV()">Export CSV</button>
  <button class="share" onclick="shareList()">Share</button>
  <button class="clear" onclick="clearAll()">Clear All</button>
</div>

<script>
  // Security: Prevent XSS by sanitizing inputs
  function sanitizeInput(input) {
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
  }

  document.getElementById("todayDate").innerText = new Date().toLocaleDateString();
  let list = JSON.parse(localStorage.getItem("shopList")) || [];

  // ENTER KEY = ADD ITEM (but not in edit mode)
  document.getElementById("item").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.target.isContentEditable) addItem();
  });
  
  document.getElementById("qty").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.target.isContentEditable) addItem();
  });
  
  document.getElementById("rate").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.target.isContentEditable) addItem();
  });

  function save() {
    localStorage.setItem("shopList", JSON.stringify(list));
    render();
  }

  function addItem() {
    const item = document.getElementById("item").value.trim();
    let qty = document.getElementById("qty").value.trim();
    let rate = document.getElementById("rate").value.trim();

    if (!item) {
      alert("Item name is required!");
      document.getElementById("item").focus();
      return;
    }

    // Validate inputs
    if (qty && isNaN(qty)) {
      alert("Quantity must be a number!");
      document.getElementById("qty").focus();
      return;
    }
    
    if (rate && isNaN(rate)) {
      alert("Rate must be a number!");
      document.getElementById("rate").focus();
      return;
    }

    qty = qty || "-";  
    rate = rate || "-";

    list.push({ 
      item: sanitizeInput(item), 
      qty: sanitizeInput(qty), 
      rate: sanitizeInput(rate), 
      done: false 
    });
    
    document.getElementById("item").value = "";
    document.getElementById("qty").value = "";
    document.getElementById("rate").value = "";
    
    // Focus back to item input for quick entry
    document.getElementById("item").focus();
    
    save();
    
    // Add animation effect to the new row
    const rows = document.querySelectorAll("#listTable tbody tr");
    if (rows.length > 0) {
      rows[rows.length - 1].classList.add("pulse");
    }
  }

  function render() {
    let total = 0;
    const tbody = document.querySelector("#listTable tbody");
    tbody.innerHTML = "";

    if (list.length === 0) {
      const emptyRow = document.createElement("tr");
      emptyRow.innerHTML = `<td colspan="6" class="empty-state">Your shopping list is empty. Add some items!</td>`;
      tbody.appendChild(emptyRow);
    } else {
      list.forEach((data, i) => {
        let amount = (!isNaN(data.qty) && !isNaN(data.rate) && data.qty !== "-" && data.rate !== "-") 
          ? data.qty * data.rate 
          : "-";
          
        if (amount !== "-") total += parseFloat(amount);

        const row = document.createElement("tr");
        row.classList.add("fade-in");
        row.innerHTML = `
          <td><input type="checkbox" ${data.done ? "checked" : ""} onchange="toggle(${i})"></td>
          <td contenteditable="true" onblur="updateItem(${i}, this.innerText, 'item')" 
              onkeydown="handleEditKeydown(event, ${i}, 'item')">${data.item}</td>
          <td contenteditable="true" onblur="updateItem(${i}, this.innerText, 'qty')" 
              onkeydown="handleEditKeydown(event, ${i}, 'qty')">${data.qty}</td>
          <td contenteditable="true" onblur="updateItem(${i}, this.innerText, 'rate')" 
              onkeydown="handleEditKeydown(event, ${i}, 'rate')">${data.rate}</td>
          <td>${amount}</td>
          <td><button class="delete-btn" onclick="deleteItem(${i})" aria-label="Delete Item">×</button></td>
        `;
        tbody.appendChild(row);
      });
    }
    
    document.getElementById("totalAmount").innerText = total.toFixed(2);
  }

  // Handle Enter key in edit mode - create new line instead of moving to next field
  function handleEditKeydown(event, index, field) {
    if (event.key === "Enter") {
      event.preventDefault();
      
      // Insert a line break at cursor position
      const selection = window.getSelection();
      const range = selection.getRangeAt(0);
      const br = document.createElement("br");
      range.insertNode(br);
      
      // Move cursor after the line break
      range.setStartAfter(br);
      range.setEndAfter(br);
      selection.removeAllRanges();
      selection.addRange(range);
    }
  }

  function updateItem(i, value, field) {
    // Validate inputs
    if (field !== "item" && isNaN(value) && value !== "-") {
      alert("Only numbers allowed for quantity and rate!");
      render();
      return;
    }
    
    list[i][field] = sanitizeInput(value);
    save();
  }

  function toggle(i) { 
    list[i].done = !list[i].done; 
    save(); 
  }

  function deleteItem(i) {
    if (confirm("Are you sure you want to delete this item?")) {
      list.splice(i, 1);
      save();
    }
  }

  function clearAll() { 
    if (confirm("Are you sure you want to clear the entire list?")) {
      list = []; 
      save(); 
    }
  }

  function exportCSV() {
    if (list.length === 0) {
      alert("Your shopping list is empty. Add some items before exporting.");
      return;
    }
    
    let csv = "Item,Qty,Rate,Amount,Status\n";
    list.forEach(a => {
      const amount = (!isNaN(a.qty) && !isNaN(a.rate) && a.qty !== "-" && a.rate !== "-") 
        ? a.qty * a.rate 
        : "-";
      const status = a.done ? "Purchased" : "Pending";
      csv += `${a.item},${a.qty},${a.rate},${amount},${status}\n`;
    });
    
    let link = document.createElement("a");
    link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
    link.download = "StarShopList_" + new Date().toISOString().slice(0, 10) + ".csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function shareList() {
    if (list.length === 0) {
      alert("Your shopping list is empty. Add some items before sharing.");
      return;
    }
    
    if (navigator.share) {
      const listText = "My Shopping List:\n" + 
        list.map((a, i) => `${i+1}. ${a.item}${a.qty !== "-" ? ` (Qty: ${a.qty})` : ""}${a.rate !== "-" ? ` @ ₹${a.rate}` : ""}${a.done ? " ✓" : ""}`).join("\n") +
        `\n\nTotal: ₹${document.getElementById("totalAmount").innerText}`;
      
      navigator.share({
        title: 'My Shopping List',
        text: listText
      })
      .catch(err => console.log('Error sharing:', err));
    } else {
      alert("Sharing is not supported on this browser. You can take a screenshot or export as CSV to share.");
    }
  }

  // Initialize the app
  render();
</script>

</body>
</html>
